<?php
  include('../../functions.inc.php');
  userIsLogged();
  require_once('../../dbconnect.php');
?>
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="stylesheet" href="../styles/styles.css" />
  <link rel="stylesheet" href="../styles/carrinho.css">
  <link rel="shortcut icon" href="../../assets/logo.png" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500&display=swap" rel="stylesheet">
  <title>Meu Carrinho</title>
  <style>
    main {
      max-width: 1000px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .produtos button {
      text-align: left;
      border: none;
      width: 100%;
    }
  </style>

</head>

<body>
  <!--Barra de navegação-->
  <?php include('navbar.html'); ?>
  <main>
    <?php

        if (!isset($_SESSION['pedido'])) { // previne que o usuário entre nessa tela sem ter um pedido atual
            echo '<script>window.location = "index.php"</script>';
        }

        $pedido = $_SESSION['pedido'];
        $taxa_entrega = number_format(3, 2);
        $preco_total = number_format($_SESSION['preco_pedido'] + $taxa_entrega, 2);
        
    ?>
    <!--Título-->
    <div class="carrinho">
      <h1>Formas De Pagamento</h1>
      <svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M27.2775 9.28876C27.1625 9.1226 27.009 8.98678 26.83 8.89295C26.6511 8.79912 26.4521 8.75007 26.25 8.75001H9.16625L7.72375 5.28751C7.53461 4.83153 7.21434 4.44199 6.80353 4.16827C6.39273 3.89455 5.90989 3.74897 5.41625 3.75001H2.5V6.25001H5.41625L11.3462 20.4813C11.4412 20.709 11.6015 20.9034 11.8068 21.0402C12.0121 21.177 12.2533 21.25 12.5 21.25H22.5C23.0212 21.25 23.4875 20.9263 23.6712 20.44L27.4212 10.44C27.4921 10.2508 27.5161 10.0472 27.491 9.84669C27.466 9.64619 27.3927 9.45474 27.2775 9.28876ZM21.6337 18.75H13.3337L10.2087 11.25H24.4462L21.6337 18.75Z"
          fill="black" />
        <path
          d="M13.125 26.25C14.1605 26.25 15 25.4105 15 24.375C15 23.3395 14.1605 22.5 13.125 22.5C12.0895 22.5 11.25 23.3395 11.25 24.375C11.25 25.4105 12.0895 26.25 13.125 26.25Z"
          fill="black" />
        <path
          d="M21.875 26.25C22.9105 26.25 23.75 25.4105 23.75 24.375C23.75 23.3395 22.9105 22.5 21.875 22.5C20.8395 22.5 20 23.3395 20 24.375C20 25.4105 20.8395 26.25 21.875 26.25Z"
          fill="black" />
      </svg>
    </div>
    <div class="linha-carrinho" style="width: 80%;"></div>

    <form class="cardapio" action="carrinho2.php" method="post">

      <!-- <section> -->
      <div class="Formas-pagamento">

          <div class="formas-dentro">
            <div>
              <h2>Cartão de credito</h2>
              <svg width="60" height="30" viewBox="0 0 23 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_760_19)">
                  <path d="M7.5959 13.9267C7.59766 14.1007 7.53021 14.2683 7.40839 14.3926C7.28657 14.5169 7.12036 14.5878 6.94632 14.5895L4.32146 14.6161C4.14742 14.6179 3.97981 14.5504 3.8555 14.4286C3.73119 14.3068 3.66036 14.1406 3.6586 13.9665L3.64532 12.6541C3.64355 12.48 3.711 12.3124 3.83282 12.1881C3.95464 12.0638 4.12085 11.993 4.29489 11.9912L6.91976 11.9647C7.0938 11.9629 7.26141 12.0303 7.38572 12.1522C7.51003 12.274 7.58085 12.4402 7.58261 12.6142L7.5959 13.9267Z" fill="black"/>
                  <path d="M19.4542 18.4006C20.1504 18.3935 20.8152 18.1102 21.3025 17.613C21.7898 17.1158 22.0596 16.4453 22.0525 15.7492L21.9463 5.2497C21.9392 4.55354 21.6559 3.88869 21.1587 3.40142C20.6614 2.91414 19.991 2.64435 19.2948 2.6514L3.54565 2.81079C2.84949 2.81784 2.18464 3.10114 1.69737 3.59838C1.21009 4.09562 0.9403 4.76607 0.947346 5.46223L1.05361 15.9617C1.06066 16.6578 1.34396 17.3227 1.8412 17.81C2.33844 18.2972 3.00888 18.567 3.70504 18.56L19.4542 18.4006ZM2.36604 15.9484L2.29963 9.38624L20.6737 9.20028L20.7401 15.7624C20.7436 16.1105 20.6087 16.4457 20.3651 16.6944C20.1215 16.943 19.789 17.0846 19.441 17.0882L3.69176 17.2476C3.34368 17.2511 3.00846 17.1162 2.75984 16.8725C2.51122 16.6289 2.36957 16.2965 2.36604 15.9484ZM3.55893 4.12323L19.3081 3.96383C19.6562 3.96031 19.9914 4.0952 20.24 4.33884C20.4887 4.58248 20.6303 4.9149 20.6338 5.26298L20.6471 6.57541L2.27306 6.76137L2.25978 5.44894C2.25626 5.10086 2.39115 4.76564 2.63479 4.51702C2.87843 4.2684 3.21085 4.12675 3.55893 4.12323Z" fill="black"/>
                </g>
                <defs>
                  <clipPath id="clip0_760_19">
                    <rect width="21" height="21" fill="white" transform="translate(22.1057 20.9989) rotate(179.42)"/>
                  </clipPath>
                </defs>
              </svg>
            </div>  
          </div>

      </div>

      <!-- <section> -->
      <div class="Formas-pagamento">

          <div class="formas-dentro">
            <div>
              <h2>Dinheiro</h2>
              <svg width="60" height="20" viewBox="0 0 19 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_760_33)">
                  <path d="M18.4407 1.59551C17.2891 1.11885 16.1366 0.9375 14.9848 0.9375C11.3282 0.937207 7.67184 2.76387 4.01523 2.76387C3.09819 2.76387 2.18173 2.64902 1.26469 2.36191C1.16167 2.32969 1.05836 2.31445 0.957422 2.31445C0.4465 2.31445 0 2.70469 0 3.24639V12.5411C0 12.9111 0.214641 13.2618 0.559313 13.4042C1.71089 13.8812 2.86336 14.0625 4.01523 14.0625C7.67184 14.0625 11.3285 12.2358 14.9851 12.2358C15.9021 12.2358 16.8186 12.3507 17.7356 12.6378C17.8386 12.67 17.9419 12.6853 18.0429 12.6853C18.5538 12.6853 19.0003 12.295 19.0003 11.7533V2.45889C19 2.08857 18.7854 1.73818 18.4407 1.59551ZM1.425 3.87363C2.02231 4.02129 2.64575 4.09541 3.287 4.13525C3.11244 4.99629 2.34531 5.64522 1.425 5.64522V3.87363ZM1.425 12.2232V10.8234C2.44536 10.8234 3.27097 11.6224 3.31639 12.6223C2.64753 12.5692 2.02231 12.4374 1.425 12.2232ZM9.5 10.3125C8.18811 10.3125 7.125 9.05303 7.125 7.5C7.125 5.94668 8.18841 4.6875 9.5 4.6875C10.8116 4.6875 11.875 5.94668 11.875 7.5C11.875 9.05361 10.8113 10.3125 9.5 10.3125ZM17.575 11.1264C17.0549 10.9978 16.5149 10.9257 15.9624 10.8791C16.1366 10.115 16.7788 9.53496 17.575 9.43535V11.1264ZM17.575 4.20908C16.658 4.09453 15.9463 3.33896 15.9181 2.40586C16.4982 2.46943 17.0489 2.58838 17.575 2.77676V4.20908Z" fill="black"/>
                </g>
                <defs>
                  <clipPath id="clip0_760_33">
                    <rect width="19" height="15" fill="white"/>
                  </clipPath>
                </defs>
              </svg>
            </div>  

            <div id="botaoTroco" class="botao-troco">
              <h4><label for="valorTroco">Troco para: <span style="margin-left: 0.3rem;">R$</span></label></h4>
              <input id="valorTroco" name="valor_troco" type="number">
            </div>
            <h4 id="sem-troco" style="margin-top: 5px;"><span style="cursor: pointer; text-decoration: underline;">Não quero troco</span></h4>
          </div>

      </div>

        <div class="linha-carrinho"></div>
        
        <div class="valor-pedido">
          <h2>Valor dos itens: <span class="valor_dinheiro" style="color: #124A15;">R$ <?php echo $_SESSION['preco_pedido']; ?></span>
            <svg width="18" height="17" viewBox="0 0 15 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M11.1281 0.578802C10.2956 0.62554 9.55579 0.857139 8.87367 1.20192C6.70821 2.29622 5.12014 4.53243 2.95477 5.62692C2.41172 5.90141 1.83273 6.10394 1.19896 6.19896C1.12778 6.20965 1.06178 6.23105 1.00201 6.26126C0.699453 6.41419 0.558338 6.79176 0.729486 7.13037L3.66613 12.9403C3.78304 13.1716 4.02094 13.3266 4.27003 13.3124C5.10267 13.2658 5.84243 13.0342 6.52455 12.6895C8.68992 11.595 10.2782 9.35866 12.4435 8.26417C12.9866 7.98968 13.5656 7.78716 14.1993 7.69214C14.2705 7.68145 14.3365 7.66004 14.3963 7.62983C14.6988 7.4769 14.84 7.09933 14.6688 6.76073L11.7323 0.950979C11.6151 0.719594 11.3773 0.564819 11.1281 0.578802ZM1.77152 7.09592C2.17189 7.00943 2.56449 6.86915 2.95682 6.70212C3.12548 7.29258 2.87624 7.92783 2.33125 8.2033L1.77152 7.09592ZM4.40956 12.3151L3.96729 11.4401C4.57153 11.1347 5.31285 11.3869 5.65567 11.9984C5.24283 12.1654 4.83093 12.2702 4.40956 12.3151ZM8.58771 8.70372C7.81084 9.09639 6.78336 8.62733 6.29268 7.65657C5.80192 6.68562 6.03381 5.58024 6.81051 5.18765C7.58721 4.79507 8.61477 5.26386 9.10553 6.2348C9.59639 7.20593 9.36423 8.31122 8.58771 8.70372ZM13.6267 6.79545C13.2781 6.87074 12.9355 6.98733 12.5936 7.12358C12.4554 6.59382 12.6524 6.03902 13.0924 5.73843L13.6267 6.79545ZM11.4412 2.47161C10.862 2.67449 10.2018 2.4152 9.89032 1.84038C10.2539 1.70649 10.6176 1.616 10.9887 1.57629L11.4412 2.47161Z" fill="#124A15"/>
            </svg>
          </h2>
          <h2>Taxa de entrega: <span class="valor_dinheiro" style="color: #124A15;">R$ <?php echo $taxa_entrega; ?></span>
            <svg width="18" height="17" viewBox="0 0 15 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M11.1281 0.578802C10.2956 0.62554 9.55579 0.857139 8.87367 1.20192C6.70821 2.29622 5.12014 4.53243 2.95477 5.62692C2.41172 5.90141 1.83273 6.10394 1.19896 6.19896C1.12778 6.20965 1.06178 6.23105 1.00201 6.26126C0.699453 6.41419 0.558338 6.79176 0.729486 7.13037L3.66613 12.9403C3.78304 13.1716 4.02094 13.3266 4.27003 13.3124C5.10267 13.2658 5.84243 13.0342 6.52455 12.6895C8.68992 11.595 10.2782 9.35866 12.4435 8.26417C12.9866 7.98968 13.5656 7.78716 14.1993 7.69214C14.2705 7.68145 14.3365 7.66004 14.3963 7.62983C14.6988 7.4769 14.84 7.09933 14.6688 6.76073L11.7323 0.950979C11.6151 0.719594 11.3773 0.564819 11.1281 0.578802ZM1.77152 7.09592C2.17189 7.00943 2.56449 6.86915 2.95682 6.70212C3.12548 7.29258 2.87624 7.92783 2.33125 8.2033L1.77152 7.09592ZM4.40956 12.3151L3.96729 11.4401C4.57153 11.1347 5.31285 11.3869 5.65567 11.9984C5.24283 12.1654 4.83093 12.2702 4.40956 12.3151ZM8.58771 8.70372C7.81084 9.09639 6.78336 8.62733 6.29268 7.65657C5.80192 6.68562 6.03381 5.58024 6.81051 5.18765C7.58721 4.79507 8.61477 5.26386 9.10553 6.2348C9.59639 7.20593 9.36423 8.31122 8.58771 8.70372ZM13.6267 6.79545C13.2781 6.87074 12.9355 6.98733 12.5936 7.12358C12.4554 6.59382 12.6524 6.03902 13.0924 5.73843L13.6267 6.79545ZM11.4412 2.47161C10.862 2.67449 10.2018 2.4152 9.89032 1.84038C10.2539 1.70649 10.6176 1.616 10.9887 1.57629L11.4412 2.47161Z" fill="#124A15"/>
            </svg>
          </h2>
          <h2>Valor total: <span id="valorTotal" title="<?php echo $preco_total;?>" class="valor_dinheiro" style="color: #124A15;">R$ <?php echo $preco_total;?></span>
            <svg width="18" height="17" viewBox="0 0 15 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M11.1281 0.578802C10.2956 0.62554 9.55579 0.857139 8.87367 1.20192C6.70821 2.29622 5.12014 4.53243 2.95477 5.62692C2.41172 5.90141 1.83273 6.10394 1.19896 6.19896C1.12778 6.20965 1.06178 6.23105 1.00201 6.26126C0.699453 6.41419 0.558338 6.79176 0.729486 7.13037L3.66613 12.9403C3.78304 13.1716 4.02094 13.3266 4.27003 13.3124C5.10267 13.2658 5.84243 13.0342 6.52455 12.6895C8.68992 11.595 10.2782 9.35866 12.4435 8.26417C12.9866 7.98968 13.5656 7.78716 14.1993 7.69214C14.2705 7.68145 14.3365 7.66004 14.3963 7.62983C14.6988 7.4769 14.84 7.09933 14.6688 6.76073L11.7323 0.950979C11.6151 0.719594 11.3773 0.564819 11.1281 0.578802ZM1.77152 7.09592C2.17189 7.00943 2.56449 6.86915 2.95682 6.70212C3.12548 7.29258 2.87624 7.92783 2.33125 8.2033L1.77152 7.09592ZM4.40956 12.3151L3.96729 11.4401C4.57153 11.1347 5.31285 11.3869 5.65567 11.9984C5.24283 12.1654 4.83093 12.2702 4.40956 12.3151ZM8.58771 8.70372C7.81084 9.09639 6.78336 8.62733 6.29268 7.65657C5.80192 6.68562 6.03381 5.58024 6.81051 5.18765C7.58721 4.79507 8.61477 5.26386 9.10553 6.2348C9.59639 7.20593 9.36423 8.31122 8.58771 8.70372ZM13.6267 6.79545C13.2781 6.87074 12.9355 6.98733 12.5936 7.12358C12.4554 6.59382 12.6524 6.03902 13.0924 5.73843L13.6267 6.79545ZM11.4412 2.47161C10.862 2.67449 10.2018 2.4152 9.89032 1.84038C10.2539 1.70649 10.6176 1.616 10.9887 1.57629L11.4412 2.47161Z" fill="#124A15"/>
            </svg>
          </h2>
        </div>

        <div style="margin-top: 5rem; display: flex; flex-direction: column; align-items: center;">
          <button id="continuar" name="finalizar_pedido">
            <span>Finalizar pedido</span>
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clip-path="url(#clip0_747_192)">
            <path d="M0.5625 1.125C0.413316 1.125 0.270242 1.18426 0.164752 1.28975C0.0592632 1.39524 0 1.53832 0 1.6875C0 1.83668 0.0592632 1.97976 0.164752 2.08525C0.270242 2.19074 0.413316 2.25 0.5625 2.25H1.81125L2.26237 4.05788L3.94763 13.041C3.97175 13.1699 4.04016 13.2863 4.14102 13.3701C4.24189 13.4539 4.36886 13.4999 4.5 13.5H5.625C5.02826 13.5 4.45597 13.7371 4.03401 14.159C3.61205 14.581 3.375 15.1533 3.375 15.75C3.375 16.3467 3.61205 16.919 4.03401 17.341C4.45597 17.7629 5.02826 18 5.625 18C6.22174 18 6.79403 17.7629 7.21599 17.341C7.63795 16.919 7.875 16.3467 7.875 15.75C7.875 15.1533 7.63795 14.581 7.21599 14.159C6.79403 13.7371 6.22174 13.5 5.625 13.5H13.5C12.9033 13.5 12.331 13.7371 11.909 14.159C11.4871 14.581 11.25 15.1533 11.25 15.75C11.25 16.3467 11.4871 16.919 11.909 17.341C12.331 17.7629 12.9033 18 13.5 18C14.0967 18 14.669 17.7629 15.091 17.341C15.5129 16.919 15.75 16.3467 15.75 15.75C15.75 15.1533 15.5129 14.581 15.091 14.159C14.669 13.7371 14.0967 13.5 13.5 13.5H14.625C14.7561 13.4999 14.8831 13.4539 14.984 13.3701C15.0848 13.2863 15.1532 13.1699 15.1774 13.041L16.8649 4.041C16.8801 3.95982 16.8772 3.87628 16.8565 3.79633C16.8357 3.71638 16.7977 3.64198 16.7449 3.5784C16.6922 3.51483 16.6261 3.46365 16.5514 3.42849C16.4767 3.39334 16.3951 3.37508 16.3125 3.375H3.25125L2.79562 1.55137C2.76526 1.42963 2.69506 1.32154 2.5962 1.24428C2.49733 1.16702 2.37547 1.12503 2.25 1.125H0.5625ZM6.75 15.75C6.75 16.0484 6.63147 16.3345 6.42049 16.5455C6.20952 16.7565 5.92337 16.875 5.625 16.875C5.32663 16.875 5.04048 16.7565 4.82951 16.5455C4.61853 16.3345 4.5 16.0484 4.5 15.75C4.5 15.4516 4.61853 15.1655 4.82951 14.9545C5.04048 14.7435 5.32663 14.625 5.625 14.625C5.92337 14.625 6.20952 14.7435 6.42049 14.9545C6.63147 15.1655 6.75 15.4516 6.75 15.75V15.75ZM14.625 15.75C14.625 16.0484 14.5065 16.3345 14.2955 16.5455C14.0845 16.7565 13.7984 16.875 13.5 16.875C13.2016 16.875 12.9155 16.7565 12.7045 16.5455C12.4935 16.3345 12.375 16.0484 12.375 15.75C12.375 15.4516 12.4935 15.1655 12.7045 14.9545C12.9155 14.7435 13.2016 14.625 13.5 14.625C13.7984 14.625 14.0845 14.7435 14.2955 14.9545C14.5065 15.1655 14.625 15.4516 14.625 15.75V15.75ZM12.7733 7.14825L9.39825 10.5233C9.346 10.5756 9.28393 10.6172 9.21559 10.6456C9.14725 10.6739 9.07399 10.6885 9 10.6885C8.92601 10.6885 8.85275 10.6739 8.78441 10.6456C8.71607 10.6172 8.654 10.5756 8.60175 10.5233L6.91425 8.83575C6.86195 8.78345 6.82047 8.72136 6.79216 8.65303C6.76386 8.5847 6.74929 8.51146 6.74929 8.4375C6.74929 8.36354 6.76386 8.2903 6.79216 8.22197C6.82047 8.15364 6.86195 8.09155 6.91425 8.03925C6.96655 7.98695 7.02864 7.94547 7.09697 7.91716C7.1653 7.88886 7.23854 7.87429 7.3125 7.87429C7.38646 7.87429 7.4597 7.88886 7.52803 7.91716C7.59636 7.94547 7.65845 7.98695 7.71075 8.03925L9 9.32963L11.9767 6.35175C12.029 6.29945 12.0911 6.25797 12.1595 6.22966C12.2278 6.20136 12.301 6.18679 12.375 6.18679C12.449 6.18679 12.5222 6.20136 12.5905 6.22966C12.6589 6.25797 12.721 6.29945 12.7733 6.35175C12.8255 6.40405 12.867 6.46614 12.8953 6.53447C12.9236 6.6028 12.9382 6.67604 12.9382 6.75C12.9382 6.82396 12.9236 6.8972 12.8953 6.96553C12.867 7.03386 12.8255 7.09595 12.7733 7.14825V7.14825Z" fill="white"/>
            </g>
            <defs>
            <clipPath id="clip0_747_192">
            <rect width="18" height="18" fill="white"/>
            </clipPath>
            </defs>
          </svg>
          </button>          
          <small style="text-align: center;" id="form-text"></small>
        </div>
        
    </form>

    <?php

        echo '<script src="../scripts/dinheiro.js"></script>';

        if (isset($_POST['valor_troco'])) {
            
            $troco = $_POST['valor_troco'];
            $id_usuario = $_SESSION['user'];

            $sql_pedido = "INSERT INTO `pedido`(`id_usuario`, `custo_pedido`, `troco_usuario`, `concluido`)
            VALUES ($id_usuario, $preco_total, $troco, 0)";

            mysqli_query($conn, $sql_pedido); // insere o pedido no banco
            
            $get_id_sql = "SELECT `id_pedido` FROM `pedido` WHERE `id_usuario` = $id_usuario && `concluido` = 0
            ORDER BY `id_pedido` DESC
            LIMIT 1";

            $id_pedido = mysqli_fetch_assoc(mysqli_query($conn, $get_id_sql))['id_pedido']; // pega o id do pedido que acabou de acontecer

            for ($i=0; $i < count($_SESSION['pedido']); $i++) { 
                $id_cardapio = $_SESSION['pedido'][$i]['id'];
                $quant = $_SESSION['pedido'][$i]['quant'];
                $obs = $_SESSION['pedido'][$i]['obs'];

                if ($obs != '') {
                  $sql_itens_pedido = "INSERT INTO `itens_pedido` (`id_pedido`, `id_cardapio`, `observacao_pedido`, `quantidade_produto`)
                  VALUES ($id_pedido, $id_cardapio, '$obs', $quant)";
                } else {
                  $sql_itens_pedido = "INSERT INTO `itens_pedido` (`id_pedido`, `id_cardapio`, `observacao_pedido`, `quantidade_produto`)
                  VALUES ($id_pedido, $id_cardapio, NULL, $quant)";
                }

                mysqli_query($conn, $sql_itens_pedido); // insere cada item do pedido na tabela itens_pedido
            }

            unset($_SESSION['pedido'], $_SESSION['preco_pedido']); // encerra o pedido atual

            echo "<script>window.location = 'pedidos.php'</script>";
        }
      
    ?>
  </main>

<footer>
<script>
  const botaoFinalizar = document.getElementById('continuar')
  
  botaoFinalizar.addEventListener('click', (e) => {
    const trocoInput = document.getElementById('valorTroco').value
    const valorTotal = document.getElementById('valorTotal').title
    const formText = document.querySelector('#form-text')

    e.preventDefault()

    if (trocoInput == 0) {
      return formText.textContent = 'Insira um valor para o troco'
    }

    if (valorTotal <= trocoInput) {
      return document.querySelector('form').submit()
    }

    formText.textContent = 'Você inseriu um troco menor que o valor do pedido'
  })

  document.getElementById('sem-troco').addEventListener('click', () => {
    document.getElementById('valorTroco').value = <?php echo $preco_total;?>
  })
</script>
</footer>
</body>

</html>